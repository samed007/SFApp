@model SFApp.ViewModels.TransaccionesViewModel

<!-- Enlazar Bootstrap 5 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
/* Paleta Surfer Pets Coruña */
:root {
    --azul-oscuro: #004D61;
    --turquesa: #009CA6;
    --verde-agua: #00BFA5;
    --gris-claro: #F5F5F5;
}

body {
    background-color: var(--gris-claro);
    font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
}

.container-caja {
    max-width: 1000px;
    margin: 40px auto;
    background: #fff;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

h3 {
    margin-top: 30px;
    color: var(--azul-oscuro);
    border-bottom: 2px solid var(--verde-agua);
    padding-bottom: 8px;
}

label {
    font-weight: bold;
    color: var(--azul-oscuro);
}

input[list],
input[type="number"],
button {
    border-radius: 8px;
}

input[list]:focus,
input[type="number"]:focus {
    outline: none;
    border-color: var(--turquesa);
    box-shadow: 0 0 5px rgba(0,156,166,0.4);
}

.btn-agregar {
    background-color: var(--turquesa);
    color: white;
    font-weight: 600;
}

.btn-agregar:hover {
    background-color: var(--verde-agua);
}

#tablaProductos th {
    background-color: var(--turquesa);
    color: white;
    text-align: center;
}

#tablaProductos td {
    text-align: center;
}

.eliminarBtn {
    background-color: #ff5252;
    color: white;
}

.eliminarBtn:hover {
    background-color: #e53935;
}

#total {
    font-size: 20px;
    font-weight: bold;
    color: var(--turquesa);
}

#confirmarTransaccionForm button {
    background-color: var(--azul-oscuro);
    color: white;
}

#confirmarTransaccionForm button:hover {
    background-color: #00677e;
}
</style>

<div class="container-caja">
    <div class="row g-3">
        <div class="col-md-6">
            <label>Producto:</label>
            <input list="productos" id="productoSeleccionado" class="form-control" placeholder="Selecciona un producto..." />
            <datalist id="productos">
                @foreach (var producto in Model.Productos)
                {
                    <option value="@producto.IdProducto" data-nombre="@producto.producto" data-marca="@producto.marca" data-precio="@producto.precioTotal">
                        @producto.producto - @producto.marca
                    </option>
                }
            </datalist>
        </div>
        <div class="col-md-3">
            <label>Cantidad:</label>
            <input type="number" id="cantidad" value="1" min="1" class="form-control" />
        </div>
        <div class="col-md-3 d-flex align-items-end">
            <button type="button" id="agregarBtn" class="btn btn-agregar w-100">Agregar</button>
        </div>
    </div>

    <h3>Productos seleccionados:</h3>
    <div class="table-responsive">
        <table class="table table-bordered" id="tablaProductos">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Producto</th>
                    <th>Marca</th>
                    <th>Precio Unitario</th>
                    <th>Cantidad</th>
                    <th>Subtotal</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <p class="text-end"><strong>Total:</strong> <span id="total">0</span></p>

    <!-- Formulario oculto para enviar la transacción -->
    <form id="confirmarTransaccionForm" asp-action="ConfirmarTransaccion" method="post">
        <button type="submit" class="btn w-100 mt-3">✅ Confirmar Transacción</button>
    </form>
</div>

<script>
let productosSeleccionados = [];

function actualizarTabla() {
    const tbody = document.querySelector("#tablaProductos tbody");
    tbody.innerHTML = "";
    let total = 0;

    productosSeleccionados.forEach((p, index) => {
        const subtotal = p.precio * p.cantidad;
        total += subtotal;

        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${p.id}</td>
            <td>${p.nombre}</td>
            <td>${p.marca}</td>
            <td>${p.precio.toFixed(2)}</td>
            <td><input type="number" value="${p.cantidad}" min="0" data-index="${index}" class="form-control cantidadInput"/></td>
            <td>${subtotal.toFixed(2)}</td>
            <td><button type="button" class="btn eliminarBtn" data-index="${index}">Eliminar</button></td>
        `;
        tbody.appendChild(row);
    });

    document.getElementById("total").innerText = total.toFixed(2);

    document.querySelectorAll(".cantidadInput").forEach(input => {
        input.addEventListener("change", (e) => {
            const idx = e.target.dataset.index;
            const nuevaCantidad = parseInt(e.target.value);
            if (nuevaCantidad <= 0) {
                productosSeleccionados.splice(idx, 1);
            } else {
                productosSeleccionados[idx].cantidad = nuevaCantidad;
            }
            actualizarTabla();
        });
    });

    document.querySelectorAll(".eliminarBtn").forEach(btn => {
        btn.addEventListener("click", (e) => {
            const idx = e.target.dataset.index;
            productosSeleccionados.splice(idx, 1);
            actualizarTabla();
        });
    });
}

document.getElementById("agregarBtn").addEventListener("click", () => {
    const id = document.getElementById("productoSeleccionado").value;
    const option = document.querySelector(`#productos option[value='${id}']`);
    if(!option) return alert("Producto no válido");

    const nombre = option.dataset.nombre;
    const marca = option.dataset.marca;
    const precio = parseFloat(option.dataset.precio);
    const cantidad = parseInt(document.getElementById("cantidad").value);

    const existente = productosSeleccionados.find(p => p.id == id);
    if(existente){
        existente.cantidad += cantidad;
        if (existente.cantidad <= 0) {
            productosSeleccionados = productosSeleccionados.filter(p => p.id != id);
        }
    } else if (cantidad > 0) {
        productosSeleccionados.push({ id, nombre, marca, precio, cantidad });
    }

    actualizarTabla();
    document.getElementById("productoSeleccionado").value = "";
    document.getElementById("cantidad").value = 1;
});

const form = document.getElementById("confirmarTransaccionForm");
form.addEventListener("submit", (e) => {
    form.querySelectorAll("input").forEach(input => input.remove());
    productosSeleccionados.forEach((p, index) => {
        const campos = [
            { name: `ProductosSeleccionados[${index}].Producto.IdProducto`, value: p.id },
            { name: `ProductosSeleccionados[${index}].Producto.producto`, value: p.nombre },
            { name: `ProductosSeleccionados[${index}].Producto.marca`, value: p.marca },
            { name: `ProductosSeleccionados[${index}].Producto.precioTotal`, value: p.precio },
            { name: `ProductosSeleccionados[${index}].Cantidad`, value: p.cantidad }
        ];
        campos.forEach(c => {
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = c.name;
            input.value = c.value;
            form.appendChild(input);
        });
    });
});
</script>
