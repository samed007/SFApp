@model SFApp.ViewModels.TransaccionesViewModel

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">



<div class="container-caja">
    <div class="row g-3 mb-3">
        <div class="col-md-6">
            <label>Producto:</label>
            <div class="input-group">
                <span class="input-group-text"><i class="bi bi-box"></i></span>
                <input list="productos" id="productoSeleccionado" class="form-control" placeholder="Selecciona un producto..." />
            </div>
            <datalist id="productos">
                @foreach (var producto in Model.Productos)
                {
                    <option 
                        value="@producto.IdProducto"
                        data-nombre="@producto.Producto"
                        data-marca="@producto.Marca"
                        data-precio="@producto.PrecioTotal.ToString("0.00")">
                        @producto.Producto - @producto.Marca
                    </option>
                }
            </datalist>
        </div>

        <div class="col-md-3">
            <label>Cantidad:</label>
            <input type="number" id="cantidad" value="1" min="1" class="form-control"/>
        </div>

        <div class="col-md-3 d-flex align-items-end gap-2">
            <button type="button" id="agregarBtn" class="btn btn-agregar w-100">Agregar</button>
            <button type="button" id="limpiarBtn" class="btn btn-danger w-100">Limpiar</button>
        </div>
    </div>

    <h3>Productos seleccionados:</h3>

    <div class="table-responsive">
        <table class="table table-bordered" id="tablaProductos">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Producto</th>
                    <th>Marca</th>
                    <th>Precio Unitario</th>
                    <th>Cantidad</th>
                    <th>Subtotal</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <p class="text-end me-3"><strong>Total:</strong> <span id="total">0 €</span></p>

    <form id="confirmarTransaccionForm" asp-action="ConfirmarTransaccion" method="post">
        <button type="submit" class="btn w-100 mt-3">Confirmar Transacción</button>
    </form>
</div>

<div id="toastContainer" style="position: fixed; top: 20px; right: 20px; z-index: 1050;"></div>
<!-- Modal de feedback -->
<div class="modal fade" id="feedbackModal" tabindex="-1" aria-labelledby="feedbackModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="feedbackModalLabel">Mensaje</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <p id="feedbackMessage"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>


<script>
let productosSeleccionados = [];

function flashElement(el){
    if(!el) return;
    el.classList.add("flash");
    setTimeout(() => el.classList.remove("flash"), 500);
}

function actualizarTabla() {
    const tbody = document.querySelector("#tablaProductos tbody");
    tbody.innerHTML = "";
    let total = 0;

    productosSeleccionados.forEach((p, index) => {
        const subtotal = p.precio * p.cantidad;
        total += subtotal;

        const row = document.createElement("tr");
        row.classList.add("added");
        row.innerHTML = `
            <td>${p.id}</td>
            <td>${p.nombre}</td>
            <td>${p.marca}</td>
            <td class="subtotalAnim">${p.precio.toFixed(2)} €</td>
            <td><input type="number" value="${p.cantidad}" min="0" data-index="${index}" class="form-control cantidadInput"/></td>
            <td class="subtotalAnim">${subtotal.toFixed(2)} €</td>
            <td><button type="button" class="btn eliminarBtn" data-index="${index}">Eliminar</button></td>
        `;
        tbody.appendChild(row);
    });

    const totalEl = document.getElementById("total");
    totalEl.innerText = total.toFixed(2) + " €";
    flashElement(totalEl);

    document.querySelectorAll(".cantidadInput").forEach(input => {
        input.addEventListener("change", (e) => {
            const idx = e.target.dataset.index;
            const nuevaCantidad = parseInt(e.target.value);
            if (nuevaCantidad <= 0) {
                const nombreEliminado = productosSeleccionados[idx].nombre;
                productosSeleccionados.splice(idx, 1);
                showToast(`Producto "${nombreEliminado}" eliminado`);
            } else { productosSeleccionados[idx].cantidad = nuevaCantidad; }
            actualizarTabla();
        });
    });

    document.querySelectorAll(".eliminarBtn").forEach(btn => {
        btn.addEventListener("click", (e) => {
            const idx = e.target.dataset.index;
            const nombreEliminado = productosSeleccionados[idx].nombre;
            productosSeleccionados.splice(idx, 1);
            actualizarTabla();
            showToast(`Producto "${nombreEliminado}" eliminado`);
        });
    });

    document.querySelectorAll(".subtotalAnim").forEach(td => flashElement(td));
}

function showToast(message) {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.classList.add('toast-message');
    toast.innerText = message;
    container.appendChild(toast);

    setTimeout(() => toast.classList.add('show'), 50);
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => container.removeChild(toast), 400);
    }, 2500);
}

document.getElementById("agregarBtn").addEventListener("click", () => {
    const id = document.getElementById("productoSeleccionado").value;
    const option = document.querySelector(`#productos option[value='${id}']`);
    if(!option) return alert("Producto no válido");

    const nombre = option.dataset.nombre;
    const marca = option.dataset.marca;
    const precio = parseFloat(option.dataset.precio);
    const cantidad = parseInt(document.getElementById("cantidad").value);

    const existente = productosSeleccionados.find(p => p.id == id);
    if(existente){
        existente.cantidad += cantidad;
        if (existente.cantidad <= 0) {
            productosSeleccionados = productosSeleccionados.filter(p => p.id != id);
        }
    } else if (cantidad > 0) {
        productosSeleccionados.push({ id, nombre, marca, precio, cantidad });
    }

    actualizarTabla();
    document.getElementById("productoSeleccionado").value = "";
    document.getElementById("cantidad").value = 1;
    showToast(`Producto "${nombre}" agregado`);
});

document.getElementById("limpiarBtn").addEventListener("click", () => {
    if(productosSeleccionados.length === 0) return;
    if(confirm("¿Deseas limpiar todos los productos seleccionados?")) {
        productosSeleccionados = [];
        actualizarTabla();
        showToast("Todos los productos fueron eliminados");
    }
});

const form = document.getElementById("confirmarTransaccionForm");
form.addEventListener("submit", (e) => {
    form.querySelectorAll("input").forEach(input => input.remove());
    productosSeleccionados.forEach((p, index) => {
        const campos = [
            { name: `ProductosSeleccionados[${index}].Producto.IdProducto`, value: p.id },
            { name: `ProductosSeleccionados[${index}].Producto.producto`, value: p.nombre },
            { name: `ProductosSeleccionados[${index}].Producto.marca`, value: p.marca },
            { name: `ProductosSeleccionados[${index}].Producto.precioTotal`, value: p.precio },
            { name: `ProductosSeleccionados[${index}].Cantidad`, value: p.cantidad }
        ];
        campos.forEach(c => {
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = c.name;
            input.value = c.value;
            form.appendChild(input);
        });
    });
});
</script>

@if (TempData["SuccessMessage"] != null)
{
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            // Convertimos el mensaje en una cadena segura sin romper el HTML ni imprimirlo fuera del script
            const msg = "@(TempData["SuccessMessage"]?.ToString().Replace("\\", "\\\\").Replace("\"", "\\\""))";

            // Insertar en el modal
            document.getElementById("feedbackMessage").innerText = msg;

            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById("feedbackModal"));
            modal.show();
        });
    </script>
}


