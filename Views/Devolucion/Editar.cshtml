@model IEnumerable<SFApp.DTOs.InventarioDTO>
@{
    ViewData["Title"] = "Editar Devolución";
    var idTransaccion = Model.FirstOrDefault()?.IdTransaccion ?? "";
    var tipo = Model.FirstOrDefault()?.Tipo ?? "DV"; 
    var albaranExistente = Model.FirstOrDefault()?.Albaran ?? "";
    var productos = ViewBag.Productos as IEnumerable<SFApp.DTOs.ProductosDTO>;

    bool esEditable = ViewBag.EsEditable ?? false;
    bool esDevolucion = ViewBag.EsDevolucion ?? false;
    bool permiteCancelar = ViewBag.PermiteCancelar ?? false;
}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">


<div class="container-caja mt-4">
    <h2 class="mb-4">Editar Transacción @idTransaccion (@tipo)</h2>

    <form id="guardarForm" asp-action="GuardarCambios" asp-controller="Devolucion" method="post">
        <input type="hidden" name="IdTransaccion" value="@idTransaccion" />
        <input type="hidden" id="Tipo" name="Tipo" value="@tipo" />

        @if (tipo != "VE" && tipo != "DV")
        {
            <div class="row mb-3">
                <div class="col-md-4">
                    <label for="albaran" class="form-label">Nº Albarán</label>
                    <input type="text" id="albaran" name="Albaran" class="form-control"
                        value="@(ViewBag.Albaran ?? "")"
                        placeholder="Introduce el albarán"
                        @(esEditable ? "" : "readonly") />
                </div>
            </div>
        }

        @if (esEditable)
        {
            <div class="row g-3 align-items-end mb-3">
                <div class="col-md-5">
                    <label for="productoId" class="form-label">Producto</label>
                    <input list="listaProductos" id="productoId" class="form-control" placeholder="ID o nombre del producto" />
                    <datalist id="listaProductos">
                        @foreach (var p in productos)
                        {
                            <option value="@p.IdProducto - @p.Producto"
                                    data-preciocompra="@p.PrecioCompra"
                                    data-preciototal="@p.PrecioTotal"
                                    data-nombre="@p.Producto"
                                    data-marca="@p.Marca">
                                @p.Producto
                            </option>
                        }
                    </datalist>
                </div>

                <div class="col-md-2">
                    <label for="cantidad" class="form-label">Cantidad</label>
                    <input type="number" id="cantidad" class="form-control" value="1" min="1" />
                </div>

                <div class="col-md-2 text-end">
                    <button type="button" id="agregarBtn" class="btn btn-agregar w-100 mt-2">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                </div>
            </div>
        }

        <hr />

        <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle" id="tablaDevolucion">
                <thead>
                    <tr>
                        <th>ID Producto</th>
                        <th>Cantidad</th>
                        @if (esEditable)
                        {
                            <th style="width: 90px;">Acciones</th>
                        }
                        <th>Subtotal</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="text-end fw-bold mt-3">
            Total: <span id="totalImporte">0.00</span> €
        </div>

        <div class="text-center mt-4">
            @if (esEditable)
            {
                <button type="button" class="btn  px-4 me-2" id="btnDevolver" title="Devolución">
                    <i class="bi bi-arrow-left-right"></i>
                </button>

                <button type="submit" class="btn  px-4 me-2" title="Guardar">
                    <i class="bi bi-save"></i>
                </button>

                @if (permiteCancelar)
                {
                    <button type="submit" name="accion" title="Cancelar" value="CANCEL" class="btn  px-4 me-2"
                            onclick="return confirm('¿Seguro que deseas cancelar esta transacción por completo?');">
                        <i class="bi bi-x-lg"></i>
                    </button>
                }
            }
            else if (esDevolucion)
            {
                <button type="button" class="btn  px-4 me-2" id="btnRevertir" title="Revertir">
                    <i class="bi bi-arrow-counterclockwise"></i>
                </button>
            }
            else
            {
                <div class="alert alert-info mt-3">
                    <i class="bi bi-lock-fill"></i> Esta transacción es de tipo <strong>@tipo</strong> y no puede ser modificada.
                </div>
            }

            <a href="@Url.Action("Index", "Devolucion")" class="btn btn-secondary px-4" title="Volver">
                <i class="bi bi-arrow-left"></i>
            </a>
        </div>
    </form>
</div>
<script>
/* --- Manteniendo toda la funcionalidad original --- */
let productos = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model));
const esEditable = @esEditable.ToString().ToLower();
const esDevolucion = @esDevolucion.ToString().ToLower();

/* Resto del script intacto tal como lo tenías */
productos = productos.map(p => {
    const option = Array.from(document.querySelectorAll("#listaProductos option"))
                        .find(o => parseInt(o.value.split("-")[0].trim()) === p.IdProducto);
    return {
        IdProducto: p.IdProducto,
        Cantidad: p.Cantidad,
        nombre: option?.dataset.nombre || "",
        marca: option?.dataset.marca || "",
        PrecioCompra: parseFloat(option?.dataset.preciocompra || 0),
        PrecioTotal: parseFloat(option?.dataset.preciototal || 0)
    };
});

const totalContainer = document.createElement("p");
totalContainer.classList.add("text-end", "fw-bold", "mt-3");
totalContainer.innerHTML = `Total: <span id="totalImporte">0.00</span> €`;
document.querySelector(".container").appendChild(totalContainer);

function getTipoTransaccion() {
    return document.getElementById("Tipo").value;
}

function calcularTotal() {
    const tipoTransaccion = getTipoTransaccion();
    let total = 0;
    productos.forEach(p => {
        let precio = (tipoTransaccion === "VE" || tipoTransaccion === "DV") ? p.PrecioTotal : p.PrecioCompra;
        total += precio * p.Cantidad;
    });
    document.getElementById("totalImporte").innerText = total.toFixed(2);
}

function renderTabla() {
    const tbody = document.querySelector("#tablaDevolucion tbody");
    tbody.innerHTML = "";

    productos.forEach((p, i) => {
        const tipoTransaccion = getTipoTransaccion();
        let precio = (tipoTransaccion === "VE" || tipoTransaccion === "DV") ? p.PrecioTotal : p.PrecioCompra;
        const subtotal = (precio * p.Cantidad).toFixed(2);

        const row = document.createElement("tr");
        row.innerHTML = `
            <td>
                ${p.IdProducto}
                <input type="hidden" name="Inventarios[${i}].IdProducto" value="${p.IdProducto}" />
            </td>
            <td>
                <input type="number" class="form-control" name="Inventarios[${i}].Cantidad"
                       value="${p.Cantidad}" min="1" ${esEditable ? "" : "readonly"} />
            </td>
            ${esEditable ? `
            <td class="text-center">
                <button type="button" class="btn btn-outline-danger btn-sm eliminarBtn" data-index="${i}"><i class="bi bi-trash"></i></button>
            </td>` : ""}
            <td>${subtotal}</td>
        `;
        tbody.appendChild(row);

        if (esEditable) {
            const inputCantidad = row.querySelector("input[name^='Inventarios']");
            inputCantidad.addEventListener("change", e => {
                const nuevaCantidad = parseInt(e.target.value);
                if (!isNaN(nuevaCantidad) && nuevaCantidad > 0) {
                    productos[i].Cantidad = nuevaCantidad;
                } else {
                    e.target.value = productos[i].Cantidad;
                }
                calcularTotal();
            });
        }
    });

    if (esEditable) {
        document.querySelectorAll(".eliminarBtn").forEach(btn => {
            btn.addEventListener("click", e => {
                const i = e.target.dataset.index;
                productos.splice(i, 1);
                renderTabla();
                calcularTotal();
            });
        });
    }

    calcularTotal();
}

if (esEditable) {
    document.getElementById("agregarBtn").addEventListener("click", () => {
        const productoInput = document.getElementById("productoId").value.trim();
        const cantidad = parseInt(document.getElementById("cantidad").value);
        if (!productoInput || cantidad <= 0) return alert("Por favor, introduce un producto válido.");

        const id = parseInt(productoInput.split("-")[0].trim());
        if (isNaN(id)) return alert("El formato del producto no es válido.");

        const option = document.querySelector(`#listaProductos option[value^='${id}']`);
        if (!option) return alert("Producto no válido");

        const tipoTransaccion = getTipoTransaccion();
        const existente = productos.find(p => p.IdProducto === id);
        if (existente) {
            existente.Cantidad += cantidad;
        } else {
            productos.push({
                IdProducto: id,
                Cantidad: cantidad,
                nombre: option.dataset.nombre,
                marca: option.dataset.marca,
                PrecioCompra: parseFloat(option.dataset.preciocompra),
                PrecioTotal: parseFloat(option.dataset.preciototal)
            });
        }

        renderTabla();
        document.getElementById("productoId").value = "";
        document.getElementById("cantidad").value = 1;
    });

    document.getElementById("btnDevolver").addEventListener("click", () => {
        if (!confirm("¿Generar devolución para esta transacción?")) return;
        document.getElementById("Tipo").value = "DV";
        renderTabla();
        document.getElementById("guardarForm").submit();
    });
}

if (esDevolucion) {
    document.getElementById("btnRevertir").addEventListener("click", () => {
        if (!confirm("¿Cancelar la devolución y revertir los cambios?")) return;
        document.getElementById("guardarForm").insertAdjacentHTML('beforeend',
            '<input type="hidden" name="accion" value="REVERTIR" />');
        document.getElementById("guardarForm").submit();
    });
}

renderTabla();
</script>
